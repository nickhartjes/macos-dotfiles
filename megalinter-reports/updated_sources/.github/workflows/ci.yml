---
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  megalinter:
    name: MegaLinter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: oxsecurity/megalinter@v8
        env:
          VALIDATE_ALL_CODEBASE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-stow:
    name: Validate Stow Packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check stow package structure
        run: |
          errors=0
          for pkg in dotfiles/*/; do
            name=$(basename "$pkg")
            count=$(find "$pkg" -type f | wc -l)
            if [ "$count" -eq 0 ]; then
              echo "::error::Stow package '$name' is empty"
              errors=$((errors + 1))
            else
              echo "✓ $name ($count files)"
            fi
          done
          exit $errors

  validate-brewfile:
    name: Validate Brewfile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check Brewfile syntax
        run: |
          while IFS= read -r line; do
            [[ "$line" =~ ^[[:space:]]*# ]] && continue
            [[ -z "${line// }" ]] && continue
            if ! echo "$line" | grep -qE '^(tap|brew|cask|mas|vscode)\s'; then
              echo "::error::Invalid Brewfile line: $line"
              exit 1
            fi
          done < Brewfile
          echo "✓ Brewfile syntax valid"
